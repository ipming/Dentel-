<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>Dental Care Pet</title>
    <style>
        /* CSS STYLES */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #333;
            font-family: 'Arial', sans-serif;
            touch-action: none; /* Prevent browser zooming/scrolling */
            user-select: none;
            -webkit-user-select: none;
        }

        canvas {
            display: block;
            image-rendering: pixelated; /* Keeps pixel art crisp */
            width: 100%;
            height: 100%;
        }

        /* UI OVERLAY */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .coin-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            color: gold;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn {
            pointer-events: auto;
            background: #fff;
            border: 3px solid #4a4a4a;
            border-radius: 10px;
            padding: 10px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px #000;
        }
        .btn:active { box-shadow: 0 1px #000; transform: translateY(3px); }

        #brush-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #e0f7fa;
        }

        /* MOBILE CONTROLS */
        #controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            pointer-events: auto;
            display: grid;
            grid-template-columns: 60px 60px 60px;
            grid-template-rows: 60px 60px;
            gap: 5px;
        }
        .d-btn {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            border: 2px solid rgba(255,255,255,0.5);
            touch-action: manipulation;
        }
        .d-btn:active { background: rgba(255,255,255,0.6); }
        #btn-up { grid-column: 2; grid-row: 1; }
        #btn-left { grid-column: 1; grid-row: 2; }
        #btn-down { grid-column: 2; grid-row: 2; }
        #btn-right { grid-column: 3; grid-row: 2; }

        #action-btn {
            position: absolute;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            background: rgba(255, 200, 0, 0.5);
            border-radius: 50%;
            border: 3px solid white;
            pointer-events: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            user-select: none;
        }
        #action-btn:active { background: rgba(255, 200, 0, 0.8); }

        /* MODALS (Shop, Quiz, Timer) */
        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 5px solid #4a4a4a;
            border-radius: 15px;
            padding: 20px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            display: none; /* Hidden by default */
            pointer-events: auto;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
            z-index: 100;
        }
        
        .modal h2 { margin-top: 0; color: #333; }
        
        /* Shop Specific */
        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #eee;
            margin: 5px 0;
            padding: 10px;
            border-radius: 8px;
        }

        /* Timer Specific */
        #timer-display { font-size: 40px; color: #e74c3c; font-weight: bold; }
        #timer-instruction { font-size: 18px; color: #555; margin-bottom: 20px; min-height: 50px;}

        /* Quiz Specific */
        .quiz-option {
            display: block;
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border: 2px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div class="coin-display">
            <img src="coin.png" style="width:24px;"> <span id="coin-count">0</span>
        </div>
        
        <button id="brush-btn" class="btn">ü¶∑ Brush Teeth Mode</button>

        <!-- D-PAD for Mobile -->
        <div id="controls">
            <div id="btn-up" class="d-btn"></div>
            <div id="btn-left" class="d-btn"></div>
            <div id="btn-down" class="d-btn"></div>
            <div id="btn-right" class="d-btn"></div>
        </div>
        <div id="action-btn">INTERACT</div>
    </div>

    <!-- MODALS -->

    <!-- Login Reward -->
    <div id="login-modal" class="modal">
        <h2>üìÖ Daily Login!</h2>
        <p>Welcome back! Here is your daily reward.</p>
        <h3 style="color:gold">+50 Coins</h3>
        <button class="btn" onclick="closeModal('login-modal')">Awesome!</button>
    </div>

    <!-- Shop -->
    <div id="shop-modal" class="modal">
        <h2>üè™ Dental Shop</h2>
        <div id="shop-items">
            <!-- Dynamically filled -->
        </div>
        <button class="btn" onclick="closeModal('shop-modal')">Close</button>
    </div>

    <!-- Interaction / Quiz -->
    <div id="interact-modal" class="modal">
        <h2>ü§ñ Pet Interaction</h2>
        <p>What would you like to do?</p>
        <button class="btn" onclick="startQuiz()">Take Dental Quiz (+Coins)</button>
        <br><br>
        <button class="btn" onclick="closeModal('interact-modal')">Close</button>
    </div>

    <div id="quiz-modal" class="modal">
        <h2 id="quiz-question">Question?</h2>
        <div id="quiz-options"></div>
    </div>

    <!-- Brushing Timer -->
    <div id="timer-modal" class="modal">
        <h2>ü¶∑ Brushing Time</h2>
        <div id="timer-display">02:00</div>
        <div id="timer-instruction">Get your toothbrush ready...</div>
        <button id="start-timer-btn" class="btn" onclick="startBrushing()">Start</button>
        <button class="btn" onclick="closeModal('timer-modal'); stopBrushing();">Exit</button>
    </div>

    <script>
        // --- ASSET MANAGEMENT ---
        const images = {};
        const imageSources = {
            ground: 'ground_tile.png',
            fence: 'fence.png',
            torch: 'torch.png',
            grass1: 'grass_1.png',
            grass2: 'grass_2.png',
            grass3: 'grass_3.png',
            shop: 'shop_door.png',
            player_idle: 'char_idle.png',
            player_walk1: 'char_walk1.png',
            player_walk2: 'char_walk2.png',
            player_jump: 'char_jump.png',
            pet_idle: 'pet_idle.png',
            pet_fly1: 'pet_fly1.png',
            pet_fly2: 'pet_fly2.png',
            coin: 'coin.png',
            water: 'water.png' // Used for special effect
        };

        let assetsLoaded = 0;
        const totalAssets = Object.keys(imageSources).length;

        function loadImages() {
            for (let key in imageSources) {
                images[key] = new Image();
                images[key].src = imageSources[key];
                images[key].onload = () => {
                    assetsLoaded++;
                    if (assetsLoaded === totalAssets) startGame();
                };
                // Handle missing images gracefully
                images[key].onerror = () => {
                    console.warn("Missing image: " + imageSources[key]);
                    assetsLoaded++;
                    if (assetsLoaded === totalAssets) startGame();
                }
            }
        }

        // --- GAME STATE ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        let width, height;
        let keys = {};
        
        // Data Persistence
        let userData = {
            coins: parseInt(localStorage.getItem('dental_coins')) || 0,
            lastLogin: localStorage.getItem('dental_last_login') || null,
            inventory: JSON.parse(localStorage.getItem('dental_inventory')) || []
        };

        // Entities
        const player = { x: 300, y: 300, w: 40, h: 40, speed: 4, frame: 0, dir: 1, isMoving: false, jumping: false, jumpY: 0 };
        const pet = { x: 340, y: 300, w: 32, h: 32, frame: 0, targetX: 340, targetY: 300 };
        const shopDoor = { x: 0, y: 50, w: 60, h: 60 }; // Position updated in resize
        const grasses = [];

        // Special Effect Particles
        let particles = [];

        // --- INITIALIZATION ---
        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            shopDoor.x = width / 2 - 30; // Center the shop
            shopDoor.y = 50; 
        }

        function initGrass() {
            for(let i=0; i<30; i++) {
                grasses.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    type: Math.floor(Math.random() * 3) + 1 // 1, 2, or 3
                });
            }
        }

        function checkDailyLogin() {
            const today = new Date().toDateString();
            if (userData.lastLogin !== today) {
                userData.coins += 50;
                userData.lastLogin = today;
                saveData();
                document.getElementById('login-modal').style.display = 'block';
                updateUI();
            }
        }

        function saveData() {
            localStorage.setItem('dental_coins', userData.coins);
            localStorage.setItem('dental_last_login', userData.lastLogin);
            localStorage.setItem('dental_inventory', JSON.stringify(userData.inventory));
        }

        function startGame() {
            window.addEventListener('resize', resize);
            resize();
            initGrass();
            checkDailyLogin();
            updateUI();
            
            // Start Loop
            requestAnimationFrame(gameLoop);
        }

        loadImages(); // Kicks everything off

        // --- INPUT HANDLING ---
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        // Mobile Touch Controls
        const btnUp = document.getElementById('btn-up');
        const btnDown = document.getElementById('btn-down');
        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnAct = document.getElementById('action-btn');

        const addTouch = (elem, key) => {
            elem.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            elem.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
        };

        addTouch(btnUp, 'ArrowUp');
        addTouch(btnDown, 'ArrowDown');
        addTouch(btnLeft, 'ArrowLeft');
        addTouch(btnRight, 'ArrowRight');

        // Interact Button Logic
        btnAct.addEventListener('touchstart', (e) => { 
            e.preventDefault(); 
            interact();
        });
        btnAct.addEventListener('click', (e) => {
             interact();
        });
        // Spacebar for desktop interaction
        window.addEventListener('keydown', (e) => {
            if(e.code === 'Space') interact();
        });

        function interact() {
            // 1. Check Shop Collision
            if (checkCollision(player, shopDoor)) {
                openShop();
                return;
            }
            // 2. Pet Interaction (Always available via button for simplicity)
            document.getElementById('interact-modal').style.display = 'block';
        }

        // --- GAME LOGIC ---
        function update() {
            // Player Movement
            player.isMoving = false;
            let dx = 0; let dy = 0;

            if (keys['ArrowUp'] || keys['w']) dy = -player.speed;
            if (keys['ArrowDown'] || keys['s']) dy = player.speed;
            if (keys['ArrowLeft'] || keys['a']) { dx = -player.speed; player.dir = -1; }
            if (keys['ArrowRight'] || keys['d']) { dx = player.speed; player.dir = 1; }

            if (dx !== 0 || dy !== 0) {
                player.x += dx;
                player.y += dy;
                player.isMoving = true;
                
                // Boundaries (Fence)
                if(player.x < 40) player.x = 40;
                if(player.y < 40) player.y = 40;
                if(player.x > width - 60) player.x = width - 60;
                if(player.y > height - 60) player.y = height - 60;

                // Particle Effect (If purchased)
                if (userData.inventory.includes('sparkle')) {
                    if (Math.random() > 0.5) {
                        particles.push({
                            x: player.x + player.w/2,
                            y: player.y + player.h,
                            life: 20
                        });
                    }
                }
            }

            // Animation Frames
            const time = Date.now();
            if (player.isMoving) {
                player.frame = Math.floor(time / 200) % 2; // Flip between walk1 and walk2
            } else {
                player.frame = 0;
            }

            // Pet Logic (Follow Player)
            let dist = Math.hypot(player.x - pet.x, player.y - pet.y);
            if (dist > 60) {
                pet.x += (player.x - pet.x) * 0.05;
                pet.y += (player.y - pet.y) * 0.05;
            }
            pet.frame = Math.floor(time / 300) % 2; // Fly animation

            // Particle Logic
            particles.forEach((p, i) => {
                p.life--;
                p.y -= 1;
                if(p.life <= 0) particles.splice(i, 1);
            });
        }

        function draw() {
            // 1. Background (Tiling)
            const pat = ctx.createPattern(images.ground, "repeat");
            ctx.fillStyle = pat;
            ctx.fillRect(0, 0, width, height);

            // 2. Fence & Torches
            drawFence();

            // 3. Shop Door
            ctx.drawImage(images.shop, shopDoor.x, shopDoor.y, shopDoor.w, shopDoor.h);
            
            // 4. Grass
            grasses.forEach(g => {
                let img = images['grass' + g.type];
                ctx.drawImage(img, g.x, g.y, 32, 32);
            });

            // 5. Player
            let pImg;
            if (!player.isMoving) pImg = images.player_idle;
            else pImg = (player.frame === 0) ? images.player_walk1 : images.player_walk2;
            
            ctx.save();
            ctx.translate(player.x + player.w/2, player.y + player.h/2);
            ctx.scale(player.dir, 1); // Flip sprite based on direction
            ctx.drawImage(pImg, -player.w/2, -player.h/2, player.w, player.h);
            ctx.restore();

            // 6. Pet
            let petImg = (pet.frame === 0) ? images.pet_fly1 : images.pet_fly2;
            ctx.drawImage(petImg, pet.x, pet.y - 10 * Math.sin(Date.now()/500), pet.w, pet.h); // Floating effect

            // 7. Particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life / 20;
                ctx.drawImage(images.water, p.x, p.y, 16, 16);
                ctx.globalAlpha = 1.0;
            });
        }

        function drawFence() {
            const tileSize = 40;
            const cols = Math.ceil(width / tileSize);
            const rows = Math.ceil(height / tileSize);
            
            // Top & Bottom
            for(let i=0; i<cols; i++) {
                ctx.drawImage(images.fence, i*tileSize, 0, tileSize, tileSize);
                ctx.drawImage(images.fence, i*tileSize, height-tileSize, tileSize, tileSize);
                // Torches every 5 tiles
                if(i % 5 === 0) {
                    ctx.drawImage(images.torch, i*tileSize, -10, 30, 50);
                }
            }
            // Left & Right
            for(let i=0; i<rows; i++) {
                ctx.drawImage(images.fence, 0, i*tileSize, tileSize, tileSize);
                ctx.drawImage(images.fence, width-tileSize, i*tileSize, tileSize, tileSize);
            }
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function checkCollision(rect1, rect2) {
            return (rect1.x < rect2.x + rect2.w &&
                    rect1.x + rect1.w > rect2.x &&
                    rect1.y < rect2.y + rect2.h &&
                    rect1.y + rect1.h > rect2.y);
        }

        // --- UI & SYSTEM LOGIC ---

        function updateUI() {
            document.getElementById('coin-count').innerText = userData.coins;
        }

        // SHOP
        function openShop() {
            const list = document.getElementById('shop-items');
            list.innerHTML = '';
            
            const items = [
                { id: 'sparkle', name: 'Sparkle Trail', cost: 100, icon: 'water.png' },
                { id: 'hat', name: 'Cool Hat (Cosmetic)', cost: 500, icon: 'coin.png' }
            ];

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'shop-item';
                const hasIt = userData.inventory.includes(item.id);
                div.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <img src="${item.icon}" width="20">
                        <b>${item.name}</b>
                    </div>
                    ${hasIt ? '<span>Owned</span>' : `<button class="btn" onclick="buyItem('${item.id}', ${item.cost})">${item.cost}</button>`}
                `;
                list.appendChild(div);
            });
            document.getElementById('shop-modal').style.display = 'block';
        }

        window.buyItem = function(id, cost) {
            if (userData.coins >= cost) {
                userData.coins -= cost;
                userData.inventory.push(id);
                saveData();
                updateUI();
                openShop(); // Refresh UI
            } else {
                alert("Not enough coins!");
            }
        };

        // QUIZ
        const quizQuestions = [
            { q: "How long should you brush?", a: ["30 seconds", "2 minutes", "5 minutes"], correct: 1 },
            { q: "How often should you floss?", a: ["Once a week", "Every day", "Never"], correct: 1 },
            { q: "What helps strengthen teeth?", a: ["Sugar", "Fluoride", "Lemon Juice"], correct: 1 }
        ];

        window.startQuiz = function() {
            closeModal('interact-modal');
            const q = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
            const modal = document.getElementById('quiz-modal');
            modal.style.display = 'block';
            document.getElementById('quiz-question').innerText = q.q;
            
            const opts = document.getElementById('quiz-options');
            opts.innerHTML = '';
            q.a.forEach((ans, idx) => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option';
                btn.innerText = ans;
                btn.onclick = () => {
                    if (idx === q.correct) {
                        alert("Correct! +20 Coins");
                        userData.coins += 20;
                        saveData();
                        updateUI();
                    } else {
                        alert("Oops, try again next time!");
                    }
                    closeModal('quiz-modal');
                };
                opts.appendChild(btn);
            });
        };

        // BRUSHING TIMER
        let brushInterval;
        document.getElementById('brush-btn').addEventListener('click', () => {
            document.getElementById('timer-modal').style.display = 'block';
        });

        window.startBrushing = function() {
            document.getElementById('start-timer-btn').style.display = 'none';
            let timeLeft = 120; // 2 minutes
            const display = document.getElementById('timer-display');
            const instruct = document.getElementById('timer-instruction');

            // Play music? (Optional)
            
            brushInterval = setInterval(() => {
                timeLeft--;
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                display.innerText = `0${m}:${s < 10 ? '0'+s : s}`;

                // Instructions based on time
                if (timeLeft > 90) instruct.innerText = "Brush Top Teeth (Outer Surface)";
                else if (timeLeft > 60) instruct.innerText = "Brush Top Teeth (Inner Surface)";
                else if (timeLeft > 30) instruct.innerText = "Brush Bottom Teeth";
                else if (timeLeft > 10) instruct.innerText = "Brush Chewing Surfaces";
                else instruct.innerText = "Don't forget your tongue!";

                if (timeLeft <= 0) {
                    clearInterval(brushInterval);
                    instruct.innerText = "All done! Shiny Smile! +100 Coins";
                    userData.coins += 100;
                    saveData();
                    updateUI();
                    setTimeout(() => closeModal('timer-modal'), 3000);
                }
            }, 1000);
        };

        window.stopBrushing = function() {
            clearInterval(brushInterval);
            document.getElementById('start-timer-btn').style.display = 'inline-block';
            document.getElementById('timer-display').innerText = "02:00";
            document.getElementById('timer-instruction').innerText = "Get Ready...";
        };

        window.closeModal = function(id) {
            document.getElementById(id).style.display = 'none';
        };

    </script>
</body>
</html>
