<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="DentalPet">
    
    <link rel="manifest" href="manifest.json">

    <title>Dental Pet Adventure</title>
    <style>
        /* RESET & BASIC SETUP */
        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; user-select: none; -webkit-user-select: none; }
        body { 
            overflow: hidden; 
            background-color: #87CEEB; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #game-container { position: relative; width: 100vw; height: 100vh; overflow: hidden; }
        canvas { display: block; }

        /* UI OVERLAY */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* HUD ITEMS */
        .hud-item {
            position: absolute; background: rgba(0,0,0,0.6); color: white;
            padding: 8px 15px; border-radius: 20px; font-weight: bold; font-size: 16px;
            pointer-events: auto; display: flex; align-items: center; gap: 8px;
        }
        #coin-display { top: 20px; left: 20px; border: 2px solid gold; }
        #shop-btn { top: 20px; right: 20px; background: #4CAF50; cursor: pointer; border: 2px solid #fff; }
        
        /* TIMER & TIPS */
        #timer-container {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            text-align: center; width: 300px; pointer-events: auto; /* Allow clicking start button */
        }
        #timer-display {
            font-size: 24px; font-weight: 900; color: white; 
            text-shadow: 2px 2px 0 #000; background: rgba(0,0,0,0.3);
            padding: 5px 15px; border-radius: 10px; display: inline-block;
        }
        #tip-display {
            margin-top: 5px; font-size: 14px; color: #fff; 
            text-shadow: 1px 1px 2px black; background: rgba(0,0,100,0.4);
            padding: 5px; border-radius: 5px; display: none; /* Hidden until start */
        }
        #start-timer-btn {
            margin-top: 5px;
            background: #FF9800; color: white; border: 2px solid white;
            padding: 5px 15px; border-radius: 15px; font-weight: bold;
            cursor: pointer; pointer-events: auto;
        }

        /* CONTROLS */
        .control-btn {
            position: absolute; bottom: 40px; width: 70px; height: 70px;
            background: rgba(255, 255, 255, 0.3); border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.6); pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            font-size: 30px; color: white;
        }
        .control-btn:active { background: rgba(255, 255, 255, 0.6); }
        #btn-left { left: 30px; }
        #btn-right { left: 120px; }
        #btn-jump { right: 30px; background: rgba(255, 200, 0, 0.4); }

        /* MODALS */
        .modal {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); justify-content: center; align-items: center;
            pointer-events: auto; z-index: 100;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 15px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.5); position: relative;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #888; }
        .action-btn {
            background: #4CAF50; color: white; border: none; margin-top: 10px;
            padding: 10px 20px; border-radius: 5px; font-size: 16px; cursor: pointer; width: 100%;
        }
        
        /* QUIZ STYLES */
        .quiz-option {
            background: #eee; margin: 5px 0; padding: 10px; border-radius: 5px; cursor: pointer; border: 2px solid transparent;
        }
        .quiz-option:active { background: #ddd; }
        .quiz-correct { background: #d4edda; border-color: #28a745; }
        .quiz-wrong { background: #f8d7da; border-color: #dc3545; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <!-- HUD -->
        <div id="coin-display">
            <!-- Using an img tag for HUD coin is optional, but let's keep simple text/css for HUD -->
            <span style="color: gold;">‚óè</span> <span id="coin-count">0</span>
        </div>
        <div id="shop-btn" class="hud-item">üõí Shop</div>

        <!-- Timer & Tips -->
        <div id="timer-container">
            <div id="timer-display">02:00</div>
            <button id="start-timer-btn" onclick="startBrushingTimer()">Start Brushing</button>
            <div id="tip-display">Brush in circles!</div>
        </div>

        <!-- Controls -->
        <div id="btn-left" class="control-btn">‚Üê</div>
        <div id="btn-right" class="control-btn">‚Üí</div>
        <div id="btn-jump" class="control-btn">‚Üë</div>
    </div>

    <!-- SHOP MODAL -->
    <div id="shop-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleModal('shop-modal')">√ó</span>
            <h2>Pet Shop</h2>
            <p>Spend your coins here!</p>
            <button class="action-btn" onclick="toggleModal('shop-modal')">Close</button>
        </div>
    </div>

    <!-- DAILY LOGIN MODAL -->
    <div id="daily-modal" class="modal">
        <div class="modal-content">
            <h2>Daily Bonus!</h2>
            <h1 style="color:gold; font-size: 40px;">+50</h1>
            <p>Coins added!</p>
            <button class="action-btn" onclick="claimDaily()">Awesome!</button>
        </div>
    </div>

    <!-- QUIZ MODAL -->
    <div id="quiz-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleModal('quiz-modal')">√ó</span>
            <h3 id="quiz-question">Question here?</h3>
            <div id="quiz-options"></div>
            <p id="quiz-feedback" style="margin-top:10px; font-weight:bold;"></p>
        </div>
    </div>
</div>

<script>
    // --- ASSET LOADER ---
    const assets = {};
    // Mapping your screenshot filenames to keys
    const imageSources = {
        // Character
        char_idle: 'assets/char_idle.png',
        char_jump: 'assets/char_jump.png',
        char_walk1: 'assets/char_walk1.png',
        char_walk2: 'assets/char_walk2.png',
        
        // Pet (Bee)
        pet_idle: 'assets/pet_idle.png',
        pet_fly1: 'assets/pet_fly1.png',
        pet_fly2: 'assets/pet_fly2.png',
        
        // Environment
        ground: 'assets/ground_tile.png',
        bush: 'assets/bush.png',
        grass: 'assets/grass_tuft.png',
        fence: 'assets/fence.png',
        shop_door: 'assets/shop_door.png',
        chest: 'assets/chest.png',
        coin: 'assets/coin.png',
        torch: 'assets/torch.png',
        water: 'assets/water.png'
    };
    
    function loadAssets(callback) {
        let loaded = 0;
        const total = Object.keys(imageSources).length;
        for (let key in imageSources) {
            assets[key] = new Image();
            assets[key].src = imageSources[key];
            assets[key].onload = () => { if(++loaded >= total) callback(); };
            assets[key].onerror = () => { 
                console.error("Failed to load " + key);
                if(++loaded >= total) callback(); 
            };
        }
    }

    // --- GAME VARIABLES ---
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    let coins = parseInt(localStorage.getItem('dentalCoins')) || 0;
    document.getElementById('coin-count').innerText = coins;

    // Physics
    const GRAVITY = 0.8;
    const JUMP_FORCE = -14;
    const SPEED = 6; 

    // Camera
    let cameraX = 0;

    // Input
    const keys = { left: false, right: false, up: false };

    // Player
    const player = {
        x: 100, y: 0, width: 50, height: 50, // Adjusted for sprite
        vx: 0, vy: 0,
        grounded: false,
        facingRight: true,
        animTimer: 0,
        frame: 0
    };

    // Pet
    const pet = {
        x: 60, y: 0, width: 40, height: 40,
        vx: 0, vy: 0,
        targetX: 0, targetY: 0,
        state: 'FOLLOW', 
        wanderTimer: 0,
        animTimer: 0,
        frame: 0,
        facingRight: true
    };

    // World
    const platforms = [];
    const decorations = []; // Bushes, fences, etc.
    const collectables = [];
    const groundY = 0; 

    // --- TIMER & TIPS ---
    let timeLeft = 120; 
    let timerRunning = false;
    let timerInterval;
    const tips = [
        "Brush for 2 minutes twice a day!",
        "Don't forget to floss!",
        "Brush your tongue to remove bacteria.",
        "Replace your toothbrush every 3 months.",
        "Visit the dentist twice a year!",
        "Limit sugary snacks to protect teeth."
    ];
    
    // --- QUIZ DATA ---
    const quizQuestions = [
        { q: "How often should you brush?", options: ["Once a week", "Twice a day", "Never"], a: 1 },
        { q: "What do you use to clean between teeth?", options: ["Floss", "Paper", "Nothing"], a: 0 },
        { q: "How long should you brush for?", options: ["10 seconds", "2 minutes", "1 hour"], a: 1 },
        { q: "What creates cavities?", options: ["Sugar & Bacteria", "Water", "Air"], a: 0 }
    ];

    // --- INITIALIZATION ---
    function init() {
        resize();
        window.addEventListener('resize', resize);
        setupControls();
        
        // Generate World
        generateWorld();

        checkDailyLogin();
        
        // Click listener for Pet Interaction
        canvas.addEventListener('click', checkPetClick);
        canvas.addEventListener('touchstart', checkPetClick, {passive: false});

        requestAnimationFrame(gameLoop);
    }

    function generateWorld() {
        // Create ground tiles
        for(let i=0; i<100; i++) {
            platforms.push({ x: i * 64, y: canvas.height - 64, w: 64, h: 64 });
            
            // Random Decorations
            if(i > 3 && Math.random() < 0.2) {
                let type = Math.random();
                if(type < 0.3) decorations.push({img: 'bush', x: i*64, y: canvas.height - 64 - 40, w: 50, h: 40});
                else if(type < 0.6) decorations.push({img: 'grass', x: i*64 + 10, y: canvas.height - 64 - 20, w: 30, h: 20});
                else if(type < 0.8) decorations.push({img: 'fence', x: i*64, y: canvas.height - 64 - 40, w: 64, h: 40});
            }

            // Shop Door at start
            if(i === 2) {
                decorations.push({img: 'shop_door', x: i*64, y: canvas.height - 64 - 80, w: 60, h: 80});
            }
        }
    }

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        player.y = canvas.height - 150;
        // Regenerate ground y positions on resize
        platforms.forEach(p => p.y = canvas.height - 64);
        decorations.forEach(d => {
             // Simple readjustment based on image type
             if(d.img === 'shop_door') d.y = canvas.height - 64 - 80;
             else if(d.img === 'bush' || d.img === 'fence') d.y = canvas.height - 64 - 40;
             else if(d.img === 'grass') d.y = canvas.height - 64 - 20;
        });
    }

    // --- TIMER SYSTEM ---
    function startBrushingTimer() {
        if(timerRunning) return;
        
        timerRunning = true;
        document.getElementById('start-timer-btn').style.display = 'none';
        document.getElementById('tip-display').style.display = 'block';
        
        // Initial tip
        document.getElementById('tip-display').innerText = tips[0];

        timerInterval = setInterval(() => {
            if(timeLeft > 0) {
                timeLeft--;
                let m = Math.floor(timeLeft / 60);
                let s = timeLeft % 60;
                document.getElementById('timer-display').innerText = 
                    `${m < 10 ? '0'+m : m}:${s < 10 ? '0'+s : s}`;
                
                // Change tip every 10 seconds
                if(timeLeft % 10 === 0) {
                    const randomTip = tips[Math.floor(Math.random() * tips.length)];
                    document.getElementById('tip-display').innerText = randomTip;
                }
            } else {
                clearInterval(timerInterval);
                document.getElementById('tip-display').innerText = "Great Brushing! +100 Coins";
                coins += 100;
                updateCoins();
            }
        }, 1000);
    }

    // --- DAILY LOGIN ---
    function checkDailyLogin() {
        const lastLogin = localStorage.getItem('lastLoginDate');
        const today = new Date().toDateString();
        if (lastLogin !== today) {
            document.getElementById('daily-modal').style.display = 'flex';
        }
        if (lastLogin !== today) {
            localStorage.setItem('dailyQuizzes', '0');
        }
    }

    function claimDaily() {
        coins += 50;
        updateCoins();
        localStorage.setItem('lastLoginDate', new Date().toDateString());
        document.getElementById('daily-modal').style.display = 'none';
    }

    // --- QUIZ INTERACTION ---
    function checkPetClick(e) {
        const rect = canvas.getBoundingClientRect();
        let clickX, clickY;
        
        if(e.type === 'touchstart') {
            clickX = e.touches[0].clientX - rect.left;
            clickY = e.touches[0].clientY - rect.top;
        } else {
            clickX = e.clientX - rect.left;
            clickY = e.clientY - rect.top;
        }

        const worldClickX = clickX + cameraX;
        const dist = Math.hypot(worldClickX - (pet.x + pet.width/2), clickY - (pet.y + pet.height/2));
        
        if(dist < 70) { 
            openQuiz();
        }
    }

    function openQuiz() {
        const quizzesDone = parseInt(localStorage.getItem('dailyQuizzes')) || 0;
        if(quizzesDone >= 3) {
            alert("Pet says: You've learned enough for today! Come back tomorrow.");
            return;
        }

        const qData = quizQuestions[Math.floor(Math.random() * quizQuestions.length)];
        document.getElementById('quiz-question').innerText = qData.q;
        const optContainer = document.getElementById('quiz-options');
        optContainer.innerHTML = '';
        document.getElementById('quiz-feedback').innerText = '';

        qData.options.forEach((opt, index) => {
            const div = document.createElement('div');
            div.className = 'quiz-option';
            div.innerText = opt;
            div.onclick = () => handleQuizAnswer(div, index === qData.a);
            optContainer.appendChild(div);
        });

        toggleModal('quiz-modal');
    }

    function handleQuizAnswer(element, isCorrect) {
        if(element.classList.contains('quiz-correct') || element.classList.contains('quiz-wrong')) return; 

        if(isCorrect) {
            element.classList.add('quiz-correct');
            document.getElementById('quiz-feedback').innerText = "Correct! +20 Coins";
            document.getElementById('quiz-feedback').style.color = "green";
            coins += 20;
            updateCoins();
            
            let count = parseInt(localStorage.getItem('dailyQuizzes')) || 0;
            localStorage.setItem('dailyQuizzes', count + 1);
            
            setTimeout(() => toggleModal('quiz-modal'), 1500);
        } else {
            element.classList.add('quiz-wrong');
            document.getElementById('quiz-feedback').innerText = "Oops! Try again.";
            document.getElementById('quiz-feedback').style.color = "red";
        }
    }

    // --- CORE LOGIC ---
    function update() {
        // 1. MOVEMENT
        if (keys.right) { player.vx = SPEED; player.facingRight = true; }
        else if (keys.left) { player.vx = -SPEED; player.facingRight = false; }
        else player.vx = 0;

        player.vy += GRAVITY;
        player.x += player.vx;
        player.y += player.vy;

        // 2. COLLISION
        player.grounded = false;
        platforms.forEach(plat => {
            if (player.x + player.width > plat.x && 
                player.x < plat.x + plat.w &&
                player.y + player.height > plat.y &&
                player.y + player.height < plat.y + plat.h + 20 &&
                player.vy >= 0) {
                    player.y = plat.y - player.height;
                    player.vy = 0;
                    player.grounded = true;
            }
        });

        if(player.x < 0) player.x = 0;

        // 3. RANDOM COIN SPAWNING
        if(Math.random() < 0.01) {
            const spawnX = player.x + 400 + Math.random() * 400; 
            const spawnY = canvas.height - 100 - Math.random() * 150; 
            collectables.push({ x: spawnX, y: spawnY, w: 30, h: 30, collected: false, frame: 0 });
        }

        collectables.forEach(c => {
            if (!c.collected &&
                player.x < c.x + c.w &&
                player.x + player.width > c.x &&
                player.y < c.y + c.h &&
                player.y + player.height > c.y) {
                    c.collected = true;
                    coins += 10;
                    updateCoins();
            }
        });

        // 4. PET AI
        pet.wanderTimer++;
        pet.animTimer++;
        
        if(pet.state === 'FOLLOW') {
            const targetX = player.x + (player.facingRight ? -40 : 60);
            const targetY = player.y - 40;
            pet.x += (targetX - pet.x) * 0.05;
            pet.y += (targetY - pet.y) * 0.05;
            pet.facingRight = (targetX > pet.x);

            if(Math.random() < 0.005) {
                pet.state = 'WANDER';
                pet.wanderTimer = 0;
                pet.targetX = player.x + (Math.random() * 400 - 200);
                pet.targetY = player.y - (Math.random() * 150 + 50); 
            }
        } 
        else if (pet.state === 'WANDER') {
            pet.x += (pet.targetX - pet.x) * 0.02;
            pet.y += (pet.targetY - pet.y) * 0.02;
            pet.facingRight = (pet.targetX > pet.x);

            if(pet.wanderTimer > 180) {
                pet.state = 'FOLLOW';
            }
        }

        cameraX = player.x - canvas.width / 2 + player.width / 2;
        if(cameraX < 0) cameraX = 0;
    }

    function draw() {
        ctx.fillStyle = '#87CEEB';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.save();
        ctx.translate(-cameraX, 0);

        // Draw Decorations (Behind)
        decorations.forEach(d => {
            if(assets[d.img]) {
                ctx.drawImage(assets[d.img], d.x, d.y, d.w, d.h);
            }
        });

        // Draw Ground
        platforms.forEach(p => {
            if(assets.ground) {
                ctx.drawImage(assets.ground, p.x, p.y, p.w, p.h);
            } else {
                ctx.fillStyle = '#654321';
                ctx.fillRect(p.x, p.y, p.w, p.h);
            }
        });

        // Draw Coins
        collectables.forEach(c => {
            if(!c.collected) {
                if(assets.coin) {
                    ctx.drawImage(assets.coin, c.x, c.y, c.w, c.h);
                } else {
                    ctx.fillStyle = 'gold';
                    ctx.beginPath();
                    ctx.arc(c.x + c.w/2, c.y + c.h/2, c.w/2, 0, Math.PI*2);
                    ctx.fill();
                }
            }
        });

        // Draw Player
        drawPlayer();

        // Draw Pet
        drawPet();

        ctx.restore();
    }

    function drawPlayer() {
        let sprite;
        
        // Animation Logic
        if(!player.grounded) {
            sprite = assets.char_jump;
        } else if (Math.abs(player.vx) > 0.1) {
            player.animTimer++;
            if(player.animTimer % 10 < 5) sprite = assets.char_walk1;
            else sprite = assets.char_walk2;
        } else {
            sprite = assets.char_idle;
        }

        ctx.save();
        if(!player.facingRight) {
            ctx.translate(player.x + player.width, player.y);
            ctx.scale(-1, 1);
            ctx.drawImage(sprite, 0, 0, player.width, player.height);
        } else {
            ctx.drawImage(sprite, player.x, player.y, player.width, player.height);
        }
        ctx.restore();
    }

    function drawPet() {
        let sprite;
        // Flapping animation
        if(pet.animTimer % 10 < 5) sprite = assets.pet_fly1;
        else sprite = assets.pet_fly2;

        ctx.save();
        if(!pet.facingRight) {
            ctx.translate(pet.x + pet.width, pet.y);
            ctx.scale(-1, 1);
            ctx.drawImage(sprite, 0, 0, pet.width, pet.height);
        } else {
            ctx.drawImage(sprite, pet.x, pet.y, pet.width, pet.height);
        }
        ctx.restore();

        // Hint
        if(Math.floor(Date.now() / 1000) % 4 === 0) {
            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText("?", pet.x + 15, pet.y - 10);
        }
    }

    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    // --- UTILS ---
    function setupControls() {
        window.addEventListener('keydown', e => {
            if(e.code === 'ArrowRight') keys.right = true;
            if(e.code === 'ArrowLeft') keys.left = true;
            if(e.code === 'ArrowUp' || e.code === 'Space') {
                if(player.grounded) player.vy = JUMP_FORCE;
            }
        });
        window.addEventListener('keyup', e => {
            if(e.code === 'ArrowRight') keys.right = false;
            if(e.code === 'ArrowLeft') keys.left = false;
        });

        const btnLeft = document.getElementById('btn-left');
        const btnRight = document.getElementById('btn-right');
        const btnJump = document.getElementById('btn-jump');

        const addTouch = (elem, key) => {
            elem.addEventListener('touchstart', (e) => { e.preventDefault(); keys[key] = true; });
            elem.addEventListener('touchend', (e) => { e.preventDefault(); keys[key] = false; });
        };

        addTouch(btnLeft, 'left');
        addTouch(btnRight, 'right');
        
        btnJump.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if(player.grounded) player.vy = JUMP_FORCE;
        });
    }

    function updateCoins() {
        document.getElementById('coin-count').innerText = coins;
        localStorage.setItem('dentalCoins', coins);
    }

    window.toggleModal = function(id) {
        const el = document.getElementById(id);
        el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
    }

    // Start
    loadAssets(init);

</script>
</body>
</html>
