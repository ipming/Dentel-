<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dental Pet Adventure</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #2c3e50;
            font-family: 'Press Start 2P', cursive;
            color: white;
            touch-action: none; /* Prevent mobile scrolling */
        }

        #gameCanvas {
            display: block;
            margin: 0 auto;
            background-color: #87CEEB; /* Sky blue */
            image-rendering: pixelated;
        }

        /* UI OVERLAYS */
        .ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .hud {
            padding: 20px;
            display: flex;
            justify-content: space-between;
            text-shadow: 2px 2px 0 #000;
            pointer-events: auto;
        }

        .btn {
            background: #e67e22;
            border: 2px solid #fff;
            color: white;
            padding: 10px;
            font-family: 'Press Start 2P', cursive;
            cursor: pointer;
            box-shadow: 4px 4px 0 #000;
        }
        .btn:active { box-shadow: 2px 2px 0 #000; transform: translate(2px, 2px); }

        /* MODALS */
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            color: #333;
            padding: 20px;
            border: 4px solid #000;
            box-shadow: 10px 10px 0 rgba(0,0,0,0.5);
            display: none; /* Hidden by default */
            text-align: center;
            z-index: 100;
            pointer-events: auto;
            min-width: 300px;
        }

        .modal h2 { margin-top: 0; color: #e67e22; }
        .modal input {
            padding: 10px;
            font-family: 'Press Start 2P';
            width: 80%;
            margin-bottom: 10px;
        }

        /* INTERACTION PROMPT */
        #interactPrompt {
            position: absolute;
            bottom: 100px; /* Positioned above player usually */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            display: none;
            pointer-events: none;
        }

        /* SHOP GRID */
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .shop-item {
            border: 2px solid #ccc;
            padding: 10px;
            cursor: pointer;
        }
        .shop-item:hover { background: #eee; }

    </style>
</head>
<body>

    <!-- GAME CANVAS -->
    <canvas id="gameCanvas"></canvas>

    <!-- UI LAYER -->
    <div class="ui-layer">
        <div class="hud">
            <div>
                <div id="playerNameDisplay">Player</div>
                <div style="color: #f1c40f; margin-top: 5px;">üí∞ <span id="coinCount">0</span></div>
            </div>
            <div>
                <div id="petNameDisplay" style="color: #fab1a0;">Pet</div>
                <button class="btn" onclick="openRenameModal()" style="font-size: 10px; margin-top:5px;">Rename</button>
            </div>
        </div>
        
        <!-- Interaction Hint -->
        <div id="interactPrompt">Press 'E' to Open Shop</div>
    </div>

    <!-- DAILY LOGIN MODAL -->
    <div id="dailyModal" class="modal">
        <h2>Daily Reward!</h2>
        <p>Welcome back!</p>
        <p style="font-size: 40px;">üéÅ</p>
        <p>You got +100 Coins!</p>
        <button class="btn" onclick="claimDaily()">Awesome!</button>
    </div>

    <!-- RENAME MODAL -->
    <div id="renameModal" class="modal">
        <h2>Identity</h2>
        <label>Player Name:</label><br>
        <input type="text" id="inputPlayerName" maxlength="10"><br>
        <label>Pet Name:</label><br>
        <input type="text" id="inputPetName" maxlength="10"><br>
        <button class="btn" onclick="saveNames()">Save</button>
        <button class="btn" style="background:#e74c3c" onclick="closeModal('renameModal')">Cancel</button>
    </div>

    <!-- SHOP MODAL -->
    <div id="shopModal" class="modal">
        <h2>Dental Shop</h2>
        <div class="shop-grid">
            <div class="shop-item" onclick="buyItem('Toothbrush', 50)">
                <div>ü™• Brush</div>
                <div>50 Coins</div>
            </div>
            <div class="shop-item" onclick="buyItem('Floss', 30)">
                <div>üßµ Floss</div>
                <div>30 Coins</div>
            </div>
        </div>
        <button class="btn" style="background:#e74c3c" onclick="closeModal('shopModal')">Leave</button>
    </div>

    <script>
        /* ================= CONFIGURATION ================= */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Game State
        let coins = parseInt(localStorage.getItem('dental_coins')) || 0;
        let playerName = localStorage.getItem('dental_playerName') || "Dr. Smile";
        let petName = localStorage.getItem('dental_petName') || "Flossy";
        let lastLogin = localStorage.getItem('dental_lastLogin') || "";

        // Update HUD immediately
        document.getElementById('coinCount').innerText = coins;
        document.getElementById('playerNameDisplay').innerText = playerName;
        document.getElementById('petNameDisplay').innerText = petName;

        /* ================= ASSET LOADING ================= */
        const images = {};
        const assetsToLoad = [
            { key: 'player', src: 'assets/char_idle.png' },
            { key: 'pet', src: 'assets/pet_idle.png' },
            { key: 'shop', src: 'assets/shop_door.png' },
            { key: 'ground', src: 'assets/ground_tile.png' }
        ];

        let assetsLoaded = 0;
        assetsToLoad.forEach(asset => {
            const img = new Image();
            img.src = asset.src;
            img.onload = () => { assetsLoaded++; };
            // Fallback if image missing
            img.onerror = () => { console.log(`Missing: ${asset.src}`); assetsLoaded++; }; 
            images[asset.key] = img;
        });

        /* ================= GAME OBJECTS ================= */
        
        // 1. PLAYER (Controlled by User)
        const player = {
            x: 100,
            y: 300,
            width: 48,
            height: 48,
            speed: 4,
            moving: false,
            direction: 1, // 1 right, -1 left
            color: '#3498db' // Fallback color
        };

        // 2. PET (AI Controlled)
        const pet = {
            x: 50,
            y: 320,
            width: 32,
            height: 32,
            speed: 1.5,
            state: 'idle', // idle, walk
            moveTimer: 0,
            direction: 1,
            color: '#e74c3c' // Fallback color
        };

        // 3. SHOP (Static Interaction Point)
        const shop = {
            x: 400,
            y: 250,
            width: 80,
            height: 80,
            color: '#f1c40f'
        };

        // Input Keys
        const keys = {
            w: false, a: false, s: false, d: false,
            ArrowUp: false, ArrowLeft: false, ArrowDown: false, ArrowRight: false
        };

        /* ================= EVENT LISTENERS ================= */
        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('keydown', (e) => {
            if(keys.hasOwnProperty(e.key)) keys[e.key] = true;
            
            // Interact Key
            if(e.key.toLowerCase() === 'e') {
                checkInteraction();
            }
        });
        window.addEventListener('keyup', (e) => {
            if(keys.hasOwnProperty(e.key)) keys[e.key] = false;
        });

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // Keep ground level relative to screen
            groundLevel = canvas.height - 100;
            player.y = groundLevel - player.height;
            pet.y = groundLevel - pet.height + 10; // Pet is smaller
            shop.y = groundLevel - shop.height;
            shop.x = canvas.width - 200; // Shop always on right side
        }
        let groundLevel = 0;
        resizeCanvas();

        /* ================= LOGIC ================= */

        // Daily Login Logic
        function checkDailyLogin() {
            const today = new Date().toDateString();
            if (lastLogin !== today) {
                document.getElementById('dailyModal').style.display = 'block';
            }
        }

        function claimDaily() {
            coins += 100;
            updateData();
            const today = new Date().toDateString();
            localStorage.setItem('dental_lastLogin', today);
            closeModal('dailyModal');
        }

        // Rename Logic
        function openRenameModal() {
            document.getElementById('inputPlayerName').value = playerName;
            document.getElementById('inputPetName').value = petName;
            document.getElementById('renameModal').style.display = 'block';
        }

        function saveNames() {
            const pName = document.getElementById('inputPlayerName').value;
            const ptName = document.getElementById('inputPetName').value;
            if(pName) playerName = pName;
            if(ptName) petName = ptName;
            updateData();
            closeModal('renameModal');
        }

        // Shop Logic
        function checkInteraction() {
            const dist = Math.abs((player.x + player.width/2) - (shop.x + shop.width/2));
            if (dist < 80) {
                document.getElementById('shopModal').style.display = 'block';
            }
        }

        function buyItem(item, cost) {
            if(coins >= cost) {
                coins -= cost;
                updateData();
                alert(`Bought ${item}!`);
            } else {
                alert("Not enough coins!");
            }
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function updateData() {
            localStorage.setItem('dental_coins', coins);
            localStorage.setItem('dental_playerName', playerName);
            localStorage.setItem('dental_petName', petName);
            
            document.getElementById('coinCount').innerText = coins;
            document.getElementById('playerNameDisplay').innerText = playerName;
            document.getElementById('petNameDisplay').innerText = petName;
        }

        /* ================= GAME LOOP ================= */

        function update() {
            // 1. Player Movement
            player.moving = false;
            if (keys.a || keys.ArrowLeft) {
                player.x -= player.speed;
                player.direction = -1;
                player.moving = true;
            }
            if (keys.d || keys.ArrowRight) {
                player.x += player.speed;
                player.direction = 1;
                player.moving = true;
            }

            // Boundaries
            if (player.x < 0) player.x = 0;
            if (player.x > canvas.width - player.width) player.x = canvas.width - player.width;

            // 2. Pet AI (Random Movement)
            pet.moveTimer++;
            if (pet.moveTimer > 100) { // Every ~1.5 seconds change mind
                pet.moveTimer = 0;
                const rand = Math.random();
                if (rand < 0.3) pet.state = 'idle';
                else if (rand < 0.6) { pet.state = 'walk'; pet.direction = -1; } // Left
                else { pet.state = 'walk'; pet.direction = 1; } // Right
            }

            if (pet.state === 'walk') {
                pet.x += pet.speed * pet.direction;
            }

            // Keep pet on screen
            if (pet.x < 0) { pet.x = 0; pet.direction = 1; }
            if (pet.x > canvas.width - pet.width) { pet.x = canvas.width - pet.width; pet.direction = -1; }

            // 3. Interaction Check (Show/Hide Prompt)
            const distToShop = Math.abs((player.x + player.width/2) - (shop.x + shop.width/2));
            const prompt = document.getElementById('interactPrompt');
            
            if (distToShop < 80) {
                prompt.style.display = 'block';
                prompt.style.left = (player.x + 20) + 'px';
                prompt.style.bottom = (canvas.height - player.y + 10) + 'px';
            } else {
                prompt.style.display = 'none';
            }
        }

        function draw() {
            // Clear Screen
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw Ground
            ctx.fillStyle = '#2ecc71';
            ctx.fillRect(0, groundLevel, canvas.width, 100);
            // If texture exists
            if(images.ground.complete && images.ground.naturalWidth !== 0) {
                // Simple tiling
                for(let i=0; i<canvas.width; i+=50) {
                    ctx.drawImage(images.ground, i, groundLevel, 50, 50);
                }
            }

            // Draw Shop
            if(images.shop.complete && images.shop.naturalWidth !== 0) {
                ctx.drawImage(images.shop, shop.x, shop.y, shop.width, shop.height);
            } else {
                ctx.fillStyle = shop.color;
                ctx.fillRect(shop.x, shop.y, shop.width, shop.height);
            }
            // Shop Label
            ctx.fillStyle = "white";
            ctx.font = "12px 'Press Start 2P'";
            ctx.textAlign = "center";
            ctx.fillText("SHOP", shop.x + shop.width/2, shop.y - 10);

            // Draw Player
            ctx.save();
            if (player.direction === -1) {
                ctx.scale(-1, 1);
                ctx.translate(-player.x * 2 - player.width, 0);
            }
            
            if(images.player.complete && images.player.naturalWidth !== 0) {
                ctx.drawImage(images.player, player.x, player.y, player.width, player.height);
            } else {
                ctx.fillStyle = player.color;
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }
            ctx.restore();

            // Draw Player Name
            ctx.fillStyle = "white";
            ctx.font = "10px 'Press Start 2P'";
            ctx.fillText(playerName, player.x + player.width/2, player.y - 10);


            // Draw Pet
            ctx.save();
            if (pet.direction === -1) {
                ctx.scale(-1, 1);
                ctx.translate(-pet.x * 2 - pet.width, 0);
            }

            if(images.pet.complete && images.pet.naturalWidth !== 0) {
                ctx.drawImage(images.pet, pet.x, pet.y, pet.width, pet.height);
            } else {
                ctx.fillStyle = pet.color;
                ctx.fillRect(pet.x, pet.y, pet.width, pet.height);
            }
            ctx.restore();

            // Draw Pet Name
            ctx.fillStyle = "#fab1a0";
            ctx.fillText(petName, pet.x + pet.width/2, pet.y - 10);
        }

        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        // Start
        checkDailyLogin();
        gameLoop();

    </script>
</body>
</html>
